<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Guard Plugin Manager</title>
<style>
  /* Dark theme basics */
  body {
    background: #121212;
    color: #eee;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0; padding: 0;
  }
  header {
    background: #1f1f1f;
    padding: 10px 20px;
    display: flex; justify-content: space-between; align-items: center;
    border-bottom: 1px solid #333;
  }
  header h1 {
    margin: 0; font-weight: 600;
  }
  main {
    padding: 20px;
  }
  nav button {
    background: #333;
    color: #eee;
    border: none;
    margin-right: 10px;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 600;
  }
  nav button.active, nav button:hover {
    background: #0066ff;
    color: white;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }
  th, td {
    padding: 10px 8px;
    border-bottom: 1px solid #333;
    text-align: left;
  }
  th {
    background: #222;
  }
  tr:hover {
    background: #1a73e8;
  }
  input[type="text"], input[type="password"], input[type="number"] {
    background: #222;
    border: 1px solid #444;
    color: #eee;
    padding: 5px 8px;
    width: 100%;
    box-sizing: border-box;
    border-radius: 4px;
  }
  button.action-btn {
    background: #0066ff;
    border: none;
    color: white;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
  }
  button.action-btn.remove {
    background: #e84444;
  }
  .password-cell {
    position: relative;
    cursor: pointer;
  }
  .password-cell span {
    user-select: none;
  }
  .add-btn {
    background: transparent;
    color: #00ff88;
    font-size: 20px;
    cursor: pointer;
    font-weight: 700;
    border: none;
  }
  #status {
    margin-top: 15px;
    font-weight: 600;
  }
  .hidden {
    display: none;
  }
</style>
</head>
<body>
<header>
  <h1>Guard Plugin Manager</h1>
  <div>
    <span id="userRoleDisplay"></span>
    <button id="logoutBtn" style="background:#e84444; margin-left:15px;">Logout</button>
  </div>
</header>
<nav id="navButtons"></nav>
<main>
  <section id="teamManagerSection" class="hidden">
    <h2>Team Manager</h2>
    <table id="teamTable">
      <thead>
        <tr>
          <th>Email</th>
          <th>Password (Click to toggle)</th>
          <th>Remove</th>
          <th>Change Permission</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td colspan="4" style="text-align:center">
            <button class="add-btn" id="addTeamBtn" title="Add Team Member">＋</button>
          </td>
        </tr>
      </tfoot>
    </table>
  </section>

  <section id="whitelistSection" class="hidden">
    <h2>Whitelist Manager</h2>
    <table id="whitelistTable">
      <thead>
        <tr>
          <th>Roblox PFP</th>
          <th>Discord User</th>
          <th>Roblox Display Name</th>
          <th>Roblox User</th>
          <th>UserID</th>
          <th>Change</th>
          <th>Remove</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td colspan="7" style="text-align:center">
            <button class="add-btn" id="addWhitelistBtn" title="Add Whitelist Entry">＋</button>
          </td>
        </tr>
      </tfoot>
    </table>
  </section>
  
  <div id="status"></div>
</main>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyBCQ7BxI4RViyGWYPgXBlG3Ta1k4KJHJSOLxoSwCFMS8v9fs4pmL4ckz9iYHDpeB_o/exec";
const WEB_APP_PASSWORD = "SecretAccessKey123!";

let currentUser = null; // {email, role}
let teamMembers = [];
let whitelist = [];

const userRoleDisplay = document.getElementById("userRoleDisplay");
const navButtons = document.getElementById("navButtons");
const teamSection = document.getElementById("teamManagerSection");
const whitelistSection = document.getElementById("whitelistSection");
const statusDiv = document.getElementById("status");
const logoutBtn = document.getElementById("logoutBtn");

// LOGIN (basic prompt for demo)
async function login() {
  const email = prompt("Enter your email:");
  if(!email) return alert("Login cancelled");
  const password = prompt("Enter your password:");
  if(!password) return alert("Login cancelled");
  
  await fetchData();
  
  // Check if email and password match team members
  const user = teamMembers.find(u => u.email.toLowerCase() === email.toLowerCase() && u.password === password);
  if(!user) return alert("Invalid login credentials");
  
  currentUser = user;
  userRoleDisplay.textContent = `${currentUser.email} (${currentUser.role})`;
  setupNav();
  showPageBasedOnRole();
}

// NAVIGATION SETUP
function setupNav() {
  navButtons.innerHTML = "";
  if(currentUser.role.toLowerCase() === "owner") {
    addNavButton("Team Manager", () => showSection("team"));
    addNavButton("Whitelist Manager", () => showSection("whitelist"));
    addNavButton("Logout", () => logout());
  } else {
    addNavButton("Whitelist Manager", () => showSection("whitelist"));
    addNavButton("Logout", () => logout());
  }
  function addNavButton(name, onClick) {
    const btn = document.createElement("button");
    btn.textContent = name;
    btn.onclick = () => {
      setActiveButton(btn);
      onClick();
    };
    navButtons.appendChild(btn);
  }
}
function setActiveButton(btn) {
  [...navButtons.children].forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
}

function showSection(name) {
  if(name === "team") {
    teamSection.classList.remove("hidden");
    whitelistSection.classList.add("hidden");
  } else {
    whitelistSection.classList.remove("hidden");
    teamSection.classList.add("hidden");
  }
}

// LOGOUT
function logout() {
  currentUser = null;
  userRoleDisplay.textContent = "";
  teamSection.classList.add("hidden");
  whitelistSection.classList.add("hidden");
  navButtons.innerHTML = "";
  clearTables();
  login();
}

// CLEAR TABLES
function clearTables() {
  document.querySelector("#teamTable tbody").innerHTML = "";
  document.querySelector("#whitelistTable tbody").innerHTML = "";
}

// FETCH DATA FROM BACKEND
async function fetchData() {
  statusDiv.textContent = "Loading data...";
  try {
    const res = await fetch(WEB_APP_URL);
    const data = await res.json();
    teamMembers = data.team || [];
    whitelist = data.whitelist || [];
    statusDiv.textContent = "Data loaded.";
  } catch(e) {
    statusDiv.textContent = "Error loading data.";
    alert("Failed to load data from server.");
  }
}

// SAVE DATA TO BACKEND
async function saveData() {
  statusDiv.textContent = "Saving data...";
  try {
    const payload = {
      password: WEB_APP_PASSWORD,
      action: "save",
      data: {team: teamMembers, whitelist}
    };
    const res = await fetch(WEB_APP_URL, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(payload)
    });
    const result = await res.json();
    if(result.success) {
      statusDiv.textContent = "Data saved successfully!";
    } else {
      statusDiv.textContent = "Error saving data: " + (result.error || "Unknown error");
      alert("Error saving data: " + (result.error || "Unknown error"));
    }
  } catch(e) {
    statusDiv.textContent = "Error saving data.";
    alert("Failed to save data to server.");
  }
}

// RENDER TEAM TABLE
function renderTeamTable() {
  const tbody = document.querySelector("#teamTable tbody");
  tbody.innerHTML = "";
  teamMembers.forEach((member, idx) => {
    const tr = document.createElement("tr");
    
    // Email (editable)
    const emailTd = document.createElement("td");
    const emailInput = document.createElement("input");
    emailInput.type = "text";
    emailInput.value = member.email;
    emailInput.onchange = e => {
      teamMembers[idx].email = e.target.value.trim();
      saveData();
    };
    emailTd.appendChild(emailInput);
    tr.appendChild(emailTd);
    
    // Password (click to toggle)
    const passwordTd = document.createElement("td");
    passwordTd.className = "password-cell";
    const pwSpan = document.createElement("span");
    pwSpan.textContent = "••••••••";
    passwordTd.appendChild(pwSpan);
    
    let visible = false;
    passwordTd.onclick = () => {
      visible = !visible;
      pwSpan.textContent = visible ? teamMembers[idx].password : "••••••••";
    };
    
    tr.appendChild(passwordTd);
    
    // Remove button
    const removeTd = document.createElement("td");
    const removeBtn = document.createElement("button");
    removeBtn.textContent = "Remove";
    removeBtn.className = "action-btn remove";
    removeBtn.onclick = () => {
      if(confirm(`Remove team member ${teamMembers[idx].email}?`)) {
        teamMembers.splice(idx, 1);
        renderTeamTable();
        saveData();
      }
    };
    removeTd.appendChild(removeBtn);
    tr.appendChild(removeTd);
    
    // Role (select dropdown)
    const roleTd = document.createElement("td");
    const roleSelect = document.createElement("select");
    ["Owner", "Staff"].forEach(role => {
      const opt = document.createElement("option");
      opt.value = role;
      opt.textContent = role;
      if(role === member.role) opt.selected = true;
      roleSelect.appendChild(opt);
    });
    roleSelect.onchange = e => {
      teamMembers[idx].role = e.target.value;
      saveData();
    };
    roleTd.appendChild(roleSelect);
    tr.appendChild(roleTd);
    
    tbody.appendChild(tr);
  });
}

// RENDER WHITELIST TABLE
function renderWhitelistTable() {
  const tbody = document.querySelector("#whitelistTable tbody");
  tbody.innerHTML = "";
  whitelist.forEach((entry, idx) => {
    const tr = document.createElement("tr");
    
    // Roblox PFP image (100x100)
    const pfpTd = document.createElement("td");
    const img = document.createElement("img");
    img.src = `https://www.roblox.com/headshot-thumbnail/image?userId=${entry.userid}&width=100&height=100&format=png`;
    img.width = 40;
    img.height = 40;
    img.style.borderRadius = "50%";
    pfpTd.appendChild(img);
    tr.appendChild(pfpTd);
    
    // Discord User (editable text)
    const discordTd = document.createElement("td");
    const discordInput = document.createElement("input");
    discordInput.type = "text";
    discordInput.value = entry.discordUser;
    discordInput.onchange = e => {
      whitelist[idx].discordUser = e.target.value.trim();
      saveData();
    };
    discordTd.appendChild(discordInput);
    tr.appendChild(discordTd);
    
    // Roblox Display Name (editable text)
    const displayTd = document.createElement("td");
    const displayInput = document.createElement("input");
    displayInput.type = "text";
    displayInput.value = entry.displayName;
    displayInput.onchange = e => {
      whitelist[idx].displayName = e.target.value.trim();
      saveData();
    };
    displayTd.appendChild(displayInput);
    tr.appendChild(displayTd);
    
    // Roblox User (editable text)
    const robloxUserTd = document.createElement("td");
    const robloxUserInput = document.createElement("input");
    robloxUserInput.type = "text";
    robloxUserInput.value = entry.robloxUser;
    robloxUserInput.onchange = e => {
      whitelist[idx].robloxUser = e.target.value.trim();
      saveData();
    };
    robloxUserTd.appendChild(robloxUserInput);
    tr.appendChild(robloxUserTd);
    
    // UserID (editable number)
    const useridTd = document.createElement("td");
    const useridInput = document.createElement("input");
    useridInput.type = "number";
    useridInput.value = entry.userid;
    useridInput.onchange = e => {
      whitelist[idx].userid = Number(e.target.value);
      saveData();
    };
    useridTd.appendChild(useridInput);
    tr.appendChild(useridTd);
    
    // Change (just a button to update Roblox info? For now we treat as manual)
    const changeTd = document.createElement("td");
    const changeBtn = document.createElement("button");
    changeBtn.textContent = "Change";
    changeBtn.className = "action-btn";
    changeBtn.onclick = () => {
      alert("You can edit the fields directly. UserID is required.");
    };
    changeTd.appendChild(changeBtn);
    tr.appendChild(changeTd);
    
    // Remove button
    const removeTd = document.createElement("td");
    const removeBtn = document.createElement("button");
    removeBtn.textContent = "Remove";
    removeBtn.className = "action-btn remove";
    removeBtn.onclick = () => {
      if(confirm(`Remove whitelist entry for ${entry.robloxUser}?`)) {
        whitelist.splice(idx, 1);
        renderWhitelistTable();
        saveData();
      }
    };
    removeTd.appendChild(removeBtn);
    tr.appendChild(removeTd);
    
    tbody.appendChild(tr);
  });
}

// ADD BUTTONS
document.getElementById("addTeamBtn").onclick = () => {
  teamMembers.push({email: "", password: "", role: "Staff"});
  renderTeamTable();
  saveData();
};
document.getElementById("addWhitelistBtn").onclick = () => {
  whitelist.push({discordUser: "", displayName: "", robloxUser: "", userid: 0});
  renderWhitelistTable();
  saveData();
};

// Show correct page based on role
function showPageBasedOnRole() {
  if(currentUser.role.toLowerCase() === "owner") {
    showSection("team");
    setActiveButton(navButtons.children[0]);
  } else {
    showSection("whitelist");
    setActiveButton(navButtons.children[0]);
  }
}

// Initialize
login().then(() => {
  renderTeamTable();
  renderWhitelistTable();
});
</script>
</body>
</html>
