<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Guard Admin Panel</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

  :root {
    --bg: #121217;
    --bg-alt: #1e1e2f;
    --accent: #7f5af0;
    --text: #ddd;
    --text-muted: #888;
    --danger: #e55353;
    --success: #4ade80;
    --border: #333355;
  }

  body {
    margin: 0; font-family: 'Inter', sans-serif;
    background: var(--bg);
    color: var(--text);
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  header {
    padding: 1rem 2rem;
    background: var(--bg-alt);
    font-size: 1.4rem;
    font-weight: 600;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  header span#user-role {
    font-weight: 400;
    color: var(--accent);
  }
  nav {
    background: var(--bg-alt);
    display: flex;
    gap: 1rem;
    padding: 0.5rem 2rem;
  }
  nav button {
    background: transparent;
    border: none;
    padding: 0.5rem 1rem;
    font-weight: 600;
    color: var(--text-muted);
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: border-color 0.3s, color 0.3s;
  }
  nav button.active,
  nav button:hover {
    color: var(--accent);
    border-bottom: 3px solid var(--accent);
  }

  main {
    flex: 1;
    overflow-y: auto;
    padding: 2rem;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 1.5rem;
  }
  th, td {
    text-align: left;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border);
    vertical-align: middle;
  }
  th {
    color: var(--accent);
    font-weight: 600;
  }
  tr:hover {
    background: #2a2a44;
  }
  input[type=text], input[type=password], input[type=number] {
    width: 100%;
    padding: 0.3rem 0.5rem;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text);
    font-size: 0.9rem;
    font-family: 'Inter', sans-serif;
  }
  input[type=text]:focus, input[type=password]:focus, input[type=number]:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 4px var(--accent);
  }
  button.add-btn {
    background: var(--accent);
    color: var(--bg);
    border: none;
    padding: 0.3rem 0.7rem;
    font-weight: 700;
    font-size: 1.2rem;
    cursor: pointer;
    border-radius: 4px;
    line-height: 1;
    user-select: none;
  }
  button.add-btn:hover {
    background: #936eff;
  }
  button.remove-btn {
    background: transparent;
    border: none;
    color: var(--danger);
    font-size: 1.3rem;
    cursor: pointer;
    user-select: none;
  }
  button.remove-btn:hover {
    color: #ff5c5c;
  }
  button.save-btn {
    background: var(--success);
    color: var(--bg);
    border: none;
    padding: 0.8rem 1.5rem;
    font-weight: 700;
    font-size: 1.1rem;
    border-radius: 6px;
    cursor: pointer;
    margin-top: 1rem;
    float: right;
  }
  button.save-btn:disabled {
    background: #3b6e40;
    cursor: default;
  }

  .password-toggle {
    cursor: pointer;
    color: var(--accent);
    user-select: none;
    font-size: 0.85rem;
    margin-left: 0.5rem;
  }

  .message {
    margin-top: 1rem;
    font-weight: 600;
  }
  .message.success {
    color: var(--success);
  }
  .message.error {
    color: var(--danger);
  }
</style>
</head>
<body>

<header>
  Guard Admin Panel
  <span id="user-role"></span>
</header>
<nav id="nav-tabs">
  <!-- Tabs inserted dynamically -->
</nav>
<main id="main-content">
  <!-- Content inserted dynamically -->
</main>

<script>
(() => {
  const API_URL = "https://script.google.com/macros/s/AKfycbwRQ7mr5Wl9wGf-O5RT7M3_FMBf3QKGJRBnCru6pq2yk3CGEpxyEQ7iungB4gIiYynt/exec";

  // MOCK: User info - replace this with real login logic
  // Change role here: "owner" or "staff"
  const currentUser = {
    email: "o@owner.com",
    role: "owner"
  };

  const navTabs = document.getElementById("nav-tabs");
  const mainContent = document.getElementById("main-content");
  const userRoleSpan = document.getElementById("user-role");
  userRoleSpan.textContent = currentUser.role.toUpperCase();

  const TABS = {
    owner: [
      { id: "team", label: "Team Manager" },
      { id: "whitelist", label: "Whitelist Manager" },
      { id: "logout", label: "Logout" }
    ],
    staff: [
      { id: "whitelist", label: "Whitelist Manager" },
      { id: "logout", label: "Logout" }
    ]
  };

  let teamData = [];
  let whitelistData = [];

  function createTabButton(tab) {
    const btn = document.createElement("button");
    btn.textContent = tab.label;
    btn.id = "tab-" + tab.id;
    btn.addEventListener("click", () => switchTab(tab.id));
    return btn;
  }

  function buildTabs() {
    navTabs.innerHTML = "";
    const tabs = currentUser.role === "owner" ? TABS.owner : TABS.staff;
    tabs.forEach(tab => navTabs.appendChild(createTabButton(tab)));
    switchTab(tabs[0].id);
  }

  function switchTab(tabId) {
    [...navTabs.children].forEach(btn => btn.classList.toggle("active", btn.id === "tab-" + tabId));
    if (tabId === "team") renderTeamManager();
    else if (tabId === "whitelist") renderWhitelistManager();
    else if (tabId === "logout") renderLogout();
  }

  // HELPERS
  function createTextInput(value = "", placeholder = "") {
    const input = document.createElement("input");
    input.type = "text";
    input.value = value;
    input.placeholder = placeholder;
    return input;
  }

  function createPasswordInput(value = "") {
    const input = document.createElement("input");
    input.type = "password";
    input.value = value;
    return input;
  }

  function createTable(headers, rows, options = {}) {
    const table = document.createElement("table");
    const thead = document.createElement("thead");
    const trHead = document.createElement("tr");
    headers.forEach(h => {
      const th = document.createElement("th");
      th.textContent = h.label || h;
      trHead.appendChild(th);
    });
    thead.appendChild(trHead);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");

    rows.forEach((row, rowIndex) => {
      const tr = document.createElement("tr");
      headers.forEach(h => {
        const td = document.createElement("td");

        // special cell renderers:
        if (h.key === "password") {
          const pwdInput = createPasswordInput(row[h.key]);
          pwdInput.style.width = "80%";
          const toggle = document.createElement("span");
          toggle.textContent = "Show";
          toggle.className = "password-toggle";
          toggle.addEventListener("click", () => {
            if (pwdInput.type === "password") {
              pwdInput.type = "text";
              toggle.textContent = "Hide";
            } else {
              pwdInput.type = "password";
              toggle.textContent = "Show";
            }
          });
          td.appendChild(pwdInput);
          td.appendChild(toggle);
          td._input = pwdInput;

        } else if (h.key === "role" && options.roleOptions) {
          const select = document.createElement("select");
          options.roleOptions.forEach(opt => {
            const option = document.createElement("option");
            option.value = opt;
            option.textContent = opt[0].toUpperCase() + opt.slice(1);
            if(row[h.key] === opt) option.selected = true;
            select.appendChild(option);
          });
          td.appendChild(select);
          td._select = select;

        } else if (h.key === "removeBtn") {
          const btn = document.createElement("button");
          btn.textContent = "âœ•";
          btn.className = "remove-btn";
          btn.title = "Remove";
          btn.addEventListener("click", () => {
            tr.remove();
            updateSaveButton();
          });
          td.appendChild(btn);

        } else if (h.key === "changeBtn") {
          const btn = document.createElement("button");
          btn.textContent = "Change";
          btn.style.background = "var(--accent)";
          btn.style.color = "var(--bg)";
          btn.style.border = "none";
          btn.style.padding = "0.2rem 0.5rem";
          btn.style.borderRadius = "4px";
          btn.style.cursor = "pointer";
          btn.addEventListener("click", () => alert("Change permission clicked - implement your logic"));
          td.appendChild(btn);

        } else {
          const input = createTextInput(row[h.key] || "");
          td.appendChild(input);
          td._input = input;
        }
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    return table;
  }

  // TEAM MANAGER

  function renderTeamManager() {
    mainContent.innerHTML = "";
    const container = document.createElement("div");

    const headers = [
      {key: "email", label: "Email"},
      {key: "password", label: "Password"},
      {key: "removeBtn", label: "Remove"},
      {key: "changeBtn", label: "Change Permission"},
    ];
    const roleOptions = ["owner", "staff"];

    const title = document.createElement("h2");
    title.textContent = "Team Manager";
    container.appendChild(title);

    const table = createTable(headers, teamData, {roleOptions});
    container.appendChild(table);

    const addBtn = document.createElement("button");
    addBtn.className = "add-btn";
    addBtn.textContent = "+ Add Member";
    addBtn.addEventListener("click", () => {
      teamData.push({email: "", password: "", role: "staff"});
      renderTeamManager();
      updateSaveButton();
    });
    container.appendChild(addBtn);

    container.appendChild(createSaveButton(() => saveData()));

    mainContent.appendChild(container);
    updateSaveButton();
  }

  // WHITELIST MANAGER

  function renderWhitelistManager() {
    mainContent.innerHTML = "";
    const container = document.createElement("div");

    const headers = [
      {key: "discorduser", label: "Discord User"},
      {key: "displayname", label: "Roblox Display Name"},
      {key: "robloxuser", label: "Roblox Username"},
      {key: "userid", label: "Roblox UserID"},
      {key: "changeBtn", label: "Change"},
      {key: "removeBtn", label: "Remove"},
    ];

    const title = document.createElement("h2");
    title.textContent = "Whitelist Manager";
    container.appendChild(title);

    const table = createTable(headers, whitelistData);
    container.appendChild(table);

    const addBtn = document.createElement("button");
    addBtn.className = "add-btn";
    addBtn.textContent = "+ Add Whitelist User";
    addBtn.addEventListener("click", () => {
      whitelistData.push({discorduser: "", displayname: "", robloxuser: "", userid: ""});
      renderWhitelistManager();
      updateSaveButton();
    });
    container.appendChild(addBtn);

    container.appendChild(createSaveButton(() => saveData()));

    mainContent.appendChild(container);
    updateSaveButton();
  }

  // LOGOUT

  function renderLogout() {
    mainContent.innerHTML = "";
    const container = document.createElement("div");
    const title = document.createElement("h2");
    title.textContent = "Logout";
    container.appendChild(title);

    const info = document.createElement("p");
    info.textContent = "Click below to logout.";
    container.appendChild(info);

    const logoutBtn = document.createElement("button");
    logoutBtn.className = "save-btn";
    logoutBtn.textContent = "Logout";
    logoutBtn.addEventListener("click", () => {
      alert("Logout functionality not implemented. This is a placeholder.");
    });
    container.appendChild(logoutBtn);

    mainContent.appendChild(container);
  }

  // SAVE BUTTON

  function createSaveButton(onClick) {
    const btn = document.createElement("button");
    btn.className = "save-btn";
    btn.textContent = "Save Changes";
    btn.disabled = true;
    btn.addEventListener("click", () => {
      btn.disabled = true;
      onClick().finally(() => btn.disabled = false);
    });
    btn._enabled = false;
    return btn;
  }

  // Gather data from tables to update teamData and whitelistData

  function gatherTeamData() {
    const table = mainContent.querySelector("table");
    if (!table) return;
    const rows = [...table.tBodies[0].rows];
    teamData = rows.map(row => {
      const email = row.cells[0]._input.value.trim();
      const password = row.cells[1]._input.value.trim();
      const role = row.cells[2]._select ? row.cells[2]._select.value : "staff";
      return {email, password, role};
    });
  }

  function gatherWhitelistData() {
    const table = mainContent.querySelector("table");
    if (!table) return;
    const rows = [...table.tBodies[0].rows];
    whitelistData = rows.map(row => {
      return {
        discorduser: row.cells[0]._input.value.trim(),
        displayname: row.cells[1]._input.value.trim(),
        robloxuser: row.cells[2]._input.value.trim(),
        userid: row.cells[3]._input.value.trim(),
      };
    });
  }

  // Called on input changes to enable save button

  function updateSaveButton() {
    gatherTeamData();
    gatherWhitelistData();

    const btn = mainContent.querySelector(".save-btn");
    if (!btn) return;

    // Basic validation: disable if any required field empty
    let disable = false;
    if (currentTab === "team") {
      disable = teamData.some(t => !t.email || !t.password);
    } else if (currentTab === "whitelist") {
      disable = whitelistData.some(w => !w.discorduser || !w.robloxuser);
    }

    btn.disabled = disable;
  }

  let currentTab = "";

  // Listen to input changes to update save button state

  function listenForChanges() {
    const table = mainContent.querySelector("table");
    if (!table) return;
    [...table.querySelectorAll("input")].forEach(input => {
      input.addEventListener("input", updateSaveButton);
    });
    [...table.querySelectorAll("select")].forEach(sel => {
      sel.addEventListener("change", updateSaveButton);
    });
  }

  // Save to Google Apps Script endpoint

  async function saveData() {
    gatherTeamData();
    gatherWhitelistData();

    const payload = {
      action: "save",
      user: currentUser.email,
      role: currentUser.role,
      team: teamData,
      whitelist: whitelistData
    };

    showMessage("Saving...", false);

    try {
      const res = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify(payload),
        headers: { "Content-Type": "application/json" },
      });
      const json = await res.json();

      if (json.status === "success") {
        showMessage("Saved successfully!", true);
      } else {
        showMessage("Failed to save: " + (json.message || "Unknown error"), true, true);
      }
    } catch (e) {
      showMessage("Network error: " + e.message, true, true);
    }
  }

  // Load data on start

  async function loadData() {
    showMessage("Loading data...", false);
    try {
      const res = await fetch(API_URL + "?action=load&user=" + encodeURIComponent(currentUser.email));
      const json = await res.json();

      if (json.status === "success") {
        teamData = json.team || [];
        whitelistData = json.whitelist || [];
        buildTabs();
        showMessage("Data loaded", true);
      } else {
        showMessage("Failed to load data: " + (json.message || "Unknown error"), true, true);
        buildTabs();
      }
    } catch (e) {
      showMessage("Network error: " + e.message, true, true);
      buildTabs();
    }
  }

  function showMessage(text, autoHide = false, isError = false) {
    let msg = mainContent.querySelector(".message");
    if (!msg) {
      msg = document.createElement("div");
      msg.className = "message";
      mainContent.appendChild(msg);
    }
    msg.textContent = text;
    msg.classList.toggle("error", isError);
    msg.classList.toggle("success", !isError);
    if (autoHide) {
      setTimeout(() => {
        msg.textContent = "";
        msg.classList.remove("error", "success");
      }, 3500);
    }
  }

  // Override save button listener to reattach on each render
  const originalRenderTeamManager = renderTeamManager;
  renderTeamManager = () => {
    originalRenderTeamManager();
    listenForChanges();
    currentTab = "team";
  };
  const originalRenderWhitelistManager = renderWhitelistManager;
  renderWhitelistManager = () => {
    originalRenderWhitelistManager();
    listenForChanges();
    currentTab = "whitelist";
  };
  renderLogout = () => {
    mainContent.innerHTML = "";
    currentTab = "logout";
  };

  loadData();

})();
</script>

</body>
</html>
