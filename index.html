<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Team & Whitelist Manager</title>
<style>
  body { background:#121212; color:#eee; font-family: Arial, sans-serif; margin: 20px; }
  h1 { text-align: center; }
  table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
  th, td { border: 1px solid #444; padding: 8px; }
  th { background: #222; }
  input, button { background:#222; border:none; color:#eee; padding:5px; }
  button { cursor: pointer; }
  button.remove { background: #c33; }
  button.save { background: #2a2; }
</style>
</head>
<body>
  <h1>Team Manager</h1>
  <table id="teamTable">
    <thead><tr><th>Email</th><th>Password</th><th>Role</th><th>Actions</th></tr></thead>
    <tbody></tbody>
  </table>
  <button id="addTeam">+ Add Team Member</button>

  <h1>Whitelist Manager</h1>
  <table id="whitelistTable">
    <thead><tr><th>Discord User</th><th>Display Name</th><th>Roblox User</th><th>UserId</th><th>Actions</th></tr></thead>
    <tbody></tbody>
  </table>
  <button id="addWhitelist">+ Add Whitelist Entry</button>

  <br/><br/>
  <button id="saveBtn" class="save">Save All Changes</button>
  <p id="status"></p>

<script>
const USERNAME = "GITHUB_USERNAME";
const REPO = "GITHUB_REPO";
const BRANCH = "GITHUB_BRANCH"; // usually "main"
const TOKEN = "GITHUB_TOKEN";

const TEAM_FILE = "team.json";
const WHITELIST_FILE = "whitelist.json";

let teamData = [];
let whitelistData = [];
let teamSha = null;
let whitelistSha = null;

const headers = {
  "Authorization": "token " + TOKEN,
  "Accept": "application/vnd.github.v3+json",
  "Content-Type": "application/json"
};

function apiGetFile(path) {
  return fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/${path}?ref=${BRANCH}`, {
    headers
  }).then(r => {
    if (!r.ok) throw new Error("Failed to fetch " + path);
    return r.json();
  });
}

function apiPutFile(path, content, sha) {
  return fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/${path}`, {
    method: "PUT",
    headers,
    body: JSON.stringify({
      message: `Update ${path}`,
      content: btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2)))),
      branch: BRANCH,
      sha
    })
  }).then(r => {
    if (!r.ok) throw new Error("Failed to save " + path);
    return r.json();
  });
}

function renderTable(tableId, data, columns, onRemove) {
  const tbody = document.querySelector(`#${tableId} tbody`);
  tbody.innerHTML = "";
  data.forEach((item, i) => {
    const tr = document.createElement("tr");
    columns.forEach(col => {
      const td = document.createElement("td");
      if(col === "actions") {
        const rmBtn = document.createElement("button");
        rmBtn.textContent = "Remove";
        rmBtn.className = "remove";
        rmBtn.onclick = () => {
          data.splice(i,1);
          renderTable(tableId, data, columns, onRemove);
        };
        td.appendChild(rmBtn);
      } else {
        const input = document.createElement("input");
        input.value = item[col] || "";
        input.oninput = e => item[col] = e.target.value;
        td.appendChild(input);
      }
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

function loadData() {
  Promise.all([apiGetFile(TEAM_FILE), apiGetFile(WHITELIST_FILE)])
    .then(([teamResp, whitelistResp]) => {
      teamSha = teamResp.sha;
      whitelistSha = whitelistResp.sha;
      teamData = JSON.parse(atob(teamResp.content));
      whitelistData = JSON.parse(atob(whitelistResp.content));
      renderTable("teamTable", teamData, ["email","password","role","actions"]);
      renderTable("whitelistTable", whitelistData, ["discorduser","displayname","robloxuser","userid","actions"]);
      status("Data loaded.");
    })
    .catch(e => status("Error loading data: " + e.message));
}

function saveData() {
  status("Saving...");
  Promise.all([
    apiPutFile(TEAM_FILE, teamData, teamSha),
    apiPutFile(WHITELIST_FILE, whitelistData, whitelistSha)
  ]).then(([teamRes, whitelistRes]) => {
    teamSha = teamRes.content.sha;
    whitelistSha = whitelistRes.content.sha;
    status("Save successful!");
  }).catch(e => status("Save failed: " + e.message));
}

function status(text) {
  document.getElementById("status").textContent = text;
}

document.getElementById("addTeam").onclick = () => {
  teamData.push({email:"",password:"",role:""});
  renderTable("teamTable", teamData, ["email","password","role","actions"]);
};

document.getElementById("addWhitelist").onclick = () => {
  whitelistData.push({discorduser:"",displayname:"",robloxuser:"",userid:""});
  renderTable("whitelistTable", whitelistData, ["discorduser","displayname","robloxuser","userid","actions"]);
};

document.getElementById("saveBtn").onclick = saveData;

loadData();
</script>
</body>
</html>
